---
title: "Introduction to for loops in R"
author: "Will Cornwell, Daniel Falster, Fonti Kar, Aniko Toth"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

# Introduction

The goal of this prac is to learn to get the computer to repeat things for you and therefore avoid tedium and burnout and stay a happy PhD student with a obedient computer rather than a frustrated, burned-out one with RSI. 
```{r}
for (i in c(3, 7, 3)) {
  print(i)
}
5 + 3

c(3, 7, 3)[2]


letters
```

# Your first for-loop

There are datasets in R already.  one of them is called `letters`.  It does this

```{r}
letters

LETTERS
```

**Exercises:**
1. Write a for loop that prints out each letter sequentially through the alphabet

```{r, drop}
for (i in letters) {
  print(i)
}
```

2. (stretch) Write a for loop that prints out every letter except `q`.  never liked `q` anyway.  

```{r, drop}
for (i in letters[letters != "q"]) {
  print(i)
}
```

Now look at the directory `data/species`.  It's full of genus level downloads from [GBIF](https://www.gbif.org).   Load all of these csv's into R and combine them into one data frame.

```{r}
library(tidyverse)
csv_file_name_vector <- list.files("data/penguins/",full.names = TRUE)
a <- read_csv("data/penguins/Aptenodytes forsteri.csv")
a

# Putting it in a list

list_of_data <- list()

aa <- read_csv(csv_file_name_vector[1])

list_of_data[[1]] <- read_csv(csv_file_name_vector[1])
list_of_data[[2]] <- read_csv(csv_file_name_vector[2])

dim(list_of_data[[1]])
dim(list_of_data[[2]])

output_df <- bind_rows(list_of_data)

dim(output_df)
```

Ugh this is gonna take forever ... what about a loop?

```{r}
files <- list.files("data/penguins/",full.names = TRUE)


pen<-list()
for (current_file in files) {
  pen[[i]] <- read_csv(files)
}

pen_all <- bind_rows(pen)
dim(pen_all)
```

**Exercises:**
1. Filter the data set to only iNaturalist records (see column institutionCode), split by species, and write each species data to a separate file in a folder called `inat_penguins`  You'll also need a function called `paste` or `paste0`

```{r, drop}

inat<-filter(pen_all,institutionCode=="iNaturalist")

for(current_species in unique(inat$species)){
  curr_df<-filter(inat, species==current_species)
  write_csv(curr_df,paste0("data/inat_penguins/",current_species,".csv"))
}


```


2. Calculate how many species, genera, families, and orders there are in this dataset

```{r, drop}
pen_all %>%
  summarise(
    n_species = n_distinct(scientificName),
    n_genera = n_distinct(genus),
    n_family = n_distinct(family),
    n_order = n_distinct(order)
  )
```

3. calculate the proportion of points from iNaturalist and eBird using the institutionCode (the code for eBird is confusingly "CLO"; the code for iNaturalist is more sensibly "iNaturalist")

```{r, drop}
sum(pen_all$institutionCode=="CLO",na.rm=T)/nrow(pen_all)
sum(pen_all$institutionCode=="iNaturalist",na.rm=T)/nrow(pen_all)
```

4. plot the geographic distribution of observations with the colors showing genus, try to make it look good.  (this blog might help https://sarahpenir.github.io/r/making-maps/)

```{r, drop}

world <- map_data("world")
worldplot <- ggplot() +
  geom_polygon(data = world, aes(x=long, y = lat, group = group)) + 
  coord_fixed(1.3)+
  geom_point(data=pen_all,aes(x=decimalLongitude,y=decimalLatitude,col=genus))+
  theme_void()
worldplot

```

5. write a for loop that makes a map of each genus in a separate file with species as the colors.  Save the maps in a folder called `penguin_maps`.  `ggsave` is a handy function.  

```{r, drop}

for (current_genus in unique(pen_all$genus)){
  curr_df<-filter(pen_all,genus==current_genus)
  world <- map_data("world")
   ggplot() +
  geom_polygon(data = world, aes(x=long, y = lat, group = group)) + 
  coord_fixed(1.3)+
  geom_point(data=curr_df,aes(x=decimalLongitude,y=decimalLatitude,col=species))+
  theme_void()
  ggsave(paste0(current_genus,".pdf"))
}

```


5. plot the geographic distribution of observations of more than 1000 penguins, with the colors showing number of penguins observed

```{r, drop}

world <- map_data("world")

pen_large_counts<-filter(pen_all,individualCount>=1000)
pen_small_counts<-filter(pen_all,individualCount<1000)
worldplot <- ggplot() +
  geom_polygon(data = world, aes(x=long, y = lat, group = group)) + 
  coord_fixed(1.3)+
  geom_point(data=pen_small_counts,aes(x=decimalLongitude,y=decimalLatitude),col="grey",alpha=0.1)+
  geom_point(data=pen_large_counts,aes(x=decimalLongitude,y=decimalLatitude),col="red")+
  theme_void()
worldplot
```



6. find a dubious penguin record and identify who's to blame
```{r, drop}
pen_bad<-filter(pen_all,decimalLatitude==0)
table(pen_bad$institutionCode)

pen_bad2<-filter(pen_all,decimalLatitude>20)
table(pen_bad2$institutionCode)
```